---
title: "p2_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Setting up the enviornment - Install the packages
```{r}
library(tidyverse)
library(broom)
library(multcomp)
library(MASS)
import::from(multcomp, glht, mcp, contrMat)
import::from(broom, tidy)
source("util.R") 
```

#Data wrangling with output file generated by software
```{r}
data <- read_csv("exampledata.csv")
map_condition <- read_csv("mapcondition.csv")

# add IV columns
data[, "EO"] <- NA
data[, "TL"] <- NA
data[, "ES"] <- NA
data[, "SS"] <- NA

# map endIndex to condition
for(i in 1:nrow(data)){
  # starting index of table is one
  index_that_maps <- data$endIndex[i] + 1
  row_to_map <- map_condition[index_that_maps,]
  data[i,]$EO <- row_to_map$`Edge orientation`
  data[i,]$TL <- row_to_map$`Target location`
  data[i,]$ES <- row_to_map$`Edge section`
  data[i,]$SS <- row_to_map$`Side section`
}

data$ES <- as.factor(data$ES)
data$SS <- as.factor(data$SS)
data$EO <- as.factor(data$EO)
```

#Graph Mean time vs IDE with grouping by Edge Orientation
```{r}
data_Edge <- data %>% group_by(EO) %>% summarise(
  Mean_Time = mean(MT),
  ID = mean(ID) ,
  median = median(MT),
  sd = sd(MT),
  min = min(MT),
  max = max(MT)
)
ggplot(data_Edge, aes(x=ID, y=Mean_Time, group=EO)) +
  geom_point(aes(color=EO))
```

#Graph Mean time vs IDE with grouping by Target Location
```{r}
data_TL <- data %>% group_by(TL) %>% summarise(
  Mean_Time = mean(MT),
  ID = mean(ID) ,
  median = median(MT),
  sd = sd(MT),
  min = min(MT),
  max = max(MT)
) 
ggplot(data_TL, aes(x=ID, y = Mean_Time, group = TL)) + 
  geom_point(aes(color =TL))
```

#Graph Mean time vs IDE with grouping by Edge Section
```{r}
data_ES <- data %>% group_by(ES) %>% summarise(
  Mean_Time = mean(MT),
  ID = mean(ID) ,
  median = median(MT),
  sd = sd(MT),
  min = min(MT),
  max = max(MT)
) 
ggplot(data_ES, aes(x=ID, y = Mean_Time, group = ES)) + 
  geom_point(aes(color = ES))
```

#Graph Mean time vs IDE with grouping by Side Section
```{r}
data_SS <- data %>% group_by(SS) %>% summarise(
  Mean_Time = mean(MT),
  ID = mean(ID) ,
  median = median(MT),
  sd = sd(MT),
  min = min(MT),
  max = max(MT)
) 
ggplot(data_SS, aes(x=ID, y = Mean_Time, group = SS)) + 
  geom_point(aes(color =SS))
```

#Graph Mean time vs IDE with grouping by ES and SS
```{r}
data_ES_SS <- data %>% group_by(ES,SS) %>% summarise(
  Mean_Time = mean(MT),
  ID = mean(ID) ,
  median = median(MT),
  sd = sd(MT),
  min = min(MT),
  max = max(MT)
)

ggplot(data_ES_SS, aes(x=ID, y=Mean_Time)) +
  geom_line(aes(linetype=ES))+
  geom_point(aes(color=SS))
```

#For H-1
#Visualize the data for interaction between Edge section and side section
```{r}
pd <- position_dodge(0.3) # ensure no overlaps
p_data <- 
  data %>% 
  ggplot(aes(x = ES, y = MT, color = SS, group = SS)) +
  stat_summary(fun.y = mean, geom = "point", shape = 18, size = 3, position = pd) + 
  stat_summary(fun.y = mean, geom = "line", position = pd) + 
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0, position = pd) + 
  ylab("Mean(Time) and 95% CI (from individual group)") +
  expand_limits(y = 0)
p_data
```


#Code for Interaction effect between Edge section and Side Section
```{r}
#Asses the above linear model with goodness of fit ANOVA
m_ss_es <- lm(MT ~ SS * ES, data = data)
anova(m_ss_es)


#If the interaction effect is not significant
m_full_main <-  update(m_ss_es, .~. - SS:ES)  
pairwise_main <- 
  glht(m_full_main,
       linfct = mcp(
         ES = "Tukey",
         SS = "Tukey"))
p_pairwise_main <- 
  tidy(confint(pairwise_main)) %>% 
  plot_glht()
p_pairwise_main


#If the interaction effect is significant
# 1. construct the matrix for each variable
ss_mat <- contrMat(table(data$SS), "Tukey")

# 2. pad other columns with zero
t_rows <- cbind(ss_mat,       (ss_mat * 0))
b_rows <- cbind((ss_mat * 0),   ss_mat)

# 3. add hypothesis labels as row names
rownames(t_rows) <- paste(levels(data$ES)[1],  rownames(t_rows), sep =": ")
rownames(b_rows)  <- paste(levels(data$ES)[2],  rownames(b_rows),  sep =": ")

# 4. concatenate them together
contrast_matrix <- rbind(
  t_rows,
  b_rows
)
contrast_matrix

# We will also need a model *only* with the interaction term
m_interaction <- update(m_ss_es, .~. - SS - ES -1)

# use the contrast matrix in glht() in place of "mcp()"
pairwise_interaction <- glht(m_interaction, linfct = contrast_matrix)  
p_pairwise_interaction <- 
  tidy(confint(pairwise_interaction)) %>% 
  plot_glht()
p_pairwise_interaction
```

#For H2
#Graph Mean time vs IDE with grouping by EO and SS, as we are adressing H2, more focussed on Horizontal edge
```{r}
data_EO_SS <- data %>% group_by(EO,SS) %>% summarise(
  Mean_Time = mean(MT),
  ID = mean(ID) ,
  median = median(MT),
  sd = sd(MT),
  min = min(MT),
  max = max(MT)
)

ggplot(data_EO_SS, aes(x=ID, y=Mean_Time)) +
  geom_line(aes(linetype=EO))+
  geom_point(aes(color=SS))
```



#Visualize the data for interaction between Edge orientation and side section
```{r}
pe <- position_dodge(0.3) 
q_data <- 
  data %>% 
  ggplot(aes(x = EO, y = MT, color = SS, group = SS)) +
  stat_summary(fun.y = mean, geom = "point", shape = 18, size = 3, position = pe) + 
  stat_summary(fun.y = mean, geom = "line", position = pe) + 
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0, position = pe) + 
  ylab("Mean(Time) and 95% CI (from individual group)") +
  expand_limits(y = 0)
q_data
```


#Code for Interaction effect between Edge Orientation and Side Section
```{r}
#Asses the above linear model with goodness of fit ANOVA
m_ss_eo <- lm(MT ~ SS * EO, data = data)
anova(m_ss_eo)


#As the interaction effect is significant
# 1. construct the matrix for each variable
ss_mat <- contrMat(table(data$SS), "Tukey")
ss_mat <- contrMat(table(data$EO), "Tukey")

# 2. pad other columns with zero
Horizontal_rows <- cbind(ss_mat,       (ss_mat * 0))
Vertical_rows <- cbind((ss_mat * 0),   ss_mat)

# 3. add hypothesis labels as row names
rownames(Horizontal_rows) <- paste(levels(data$EO)[1],  rownames(Horizontal_rows), sep =": ")
rownames(Vertical_rows)  <- paste(levels(data$ES)[2],  rownames(Vertical_rows),  sep =": ")

# 4. concatenate them together
contrast_matrix_q <- rbind(
  Horizontal_rows,
  Vertical_rows
)
contrast_matrix_q

# We will also need a model only with the interaction term
q_interaction <- update(m_ss_eo, .~. - SS - EO -1)

# use the contrast matrix in glht() in place of "mcp()"
pairwise_interaction_h2 <- glht(q_interaction, linfct = contrast_matrix_q)  
q_pairwise_interaction <- 
  tidy(confint(pairwise_interaction_h2)) %>% 
  plot_glht()
q_pairwise_interaction

```



